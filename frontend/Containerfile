# Build stage
FROM m.daocloud.io/docker.io/oven/bun:1-alpine AS builder

WORKDIR /app

# Copy package files
COPY package.json bun.lockb* ./

# Build arguments for npm registry
ARG NPM_REGISTRY
ARG NPM_REGISTRY_AUTH

# Install dependencies
RUN if [ -n "$NPM_REGISTRY" ]; then \
        echo "Using custom npm registry: $NPM_REGISTRY"; \
        bun config set registry "$NPM_REGISTRY"; \
        if [ -n "$NPM_REGISTRY_AUTH" ]; then \
            echo "Configuring registry authentication"; \
            bun config set "$NPM_REGISTRY:_authToken" "$NPM_REGISTRY_AUTH"; \
        fi; \
    fi \
    && bun install --frozen-lockfile

# Copy source code
COPY src/ ./src/
COPY public/ ./public/
COPY vite.config.js index.html ./

# Build
RUN bun run build

# Production stage
FROM m.daocloud.io/docker.io/nginx:alpine

WORKDIR /app

# Copy nginx config
COPY nginx.conf /etc/nginx/conf.d/default.conf

# Copy built files from builder
COPY --from=builder /app/dist /usr/share/nginx/html

# Copy entrypoint script
COPY --chmod=755 entrypoint.sh .

ENV NODE_ENV=production

ENTRYPOINT ["/app/entrypoint.sh"]
