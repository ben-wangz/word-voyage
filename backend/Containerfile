FROM m.daocloud.io/docker.io/oven/bun:1.1-alpine

WORKDIR /app

# Copy package files
COPY package.json bun.lockb* ./

# Build arguments for npm registry
ARG NPM_REGISTRY
ARG NPM_REGISTRY_AUTH

# Install dependencies
RUN if [ -n "$NPM_REGISTRY" ]; then \
        echo "Using custom npm registry: $NPM_REGISTRY"; \
        bun config set registry "$NPM_REGISTRY"; \
        if [ -n "$NPM_REGISTRY_AUTH" ]; then \
            echo "Configuring registry authentication"; \
            bun config set "$NPM_REGISTRY:_authToken" "$NPM_REGISTRY_AUTH"; \
        fi; \
    fi \
    && bun install --frozen-lockfile --production

# Copy application source
COPY src/ ./src/
COPY tsconfig.json ./
COPY --chmod=755 entrypoint.sh .

ENV NODE_ENV=production

EXPOSE 8080

ENTRYPOINT ["/app/entrypoint.sh"]
