# WordVoyage 设计文档

## 1. 项目概述

WordVoyage 是一个基于 AI 的文字沙盒冒险游戏，采用前后端分离的 Web 应用架构。游戏以星际探险为背景，用户通过文字描述行动与思考，AI 生成动态场景与事件，打造无边界的沙盒冒险体验。

### 1.1 核心特点
- **前后端分离架构**：前端负责用户交互与界面展示，后端处理业务逻辑与 LLM 集成，均使用 Bun 进行管理
- **沙盒冒险主题**：无固定目标，类似 Minecraft 的开放式玩法
- **AI 驱动叙事**：基于 OpenAI LLM 服务生成动态场景与事件
- **动态状态管理**：根据用户关注的事物动态记录游戏状态
- **双向交互机制**：支持用户行动描述与游戏机制质疑

## 2. 系统架构

WordVoyage 采用 **两阶段责任链架构**，以 LLM 对话为核心，所有功能通过处理链上的插件节点实现。

### 2.1 责任链核心设计

#### 2.1.1 核心设计理念
- **单一处理链**：所有请求（用户输入等）通过一条处理链传递
- **两阶段处理**：核心流程简化为预处理和事件生成两个主要阶段
- **上下文驱动**：通过修改 context 来处理数据和状态（如修改时间、背包物资、生命体征等）
- **事件溯源**：每个事件都绑定对应的 context 状态快照，保证事件生成和 context 变更的原子性

#### 2.1.2 核心组件
- **处理链 (Processing Chain)**：请求处理的核心通道，按顺序传递请求
- **插件节点 (Plugin Node)**：链上的处理单元，每个节点实现特定功能
- **LLM 核心 (LLM Core)**：链上的关键节点，负责与 OpenAI API 交互
- **Context (上下文)**：包含游戏状态的可变数据结构，节点间通过修改 context 进行交互
- **Event (事件)**：事件生成的最终产物，包含生成结果和对应的 context 快照

#### 2.1.3 节点接口

所有插件节点只需要实现以下极简接口：

```typescript
interface PluginNode {
  // 插件节点元信息
  metadata: {
    id: string;           // 唯一标识符
    name: string;         // 名称
    version: string;      // 版本
  };
  
  // 处理请求（核心方法）
  process(request: Request, context: Context, next: () => Promise<Response>): Promise<Response>;
}
```

**接口说明：**
- `request`：当前处理的请求对象
- `context`：包含全局状态和上下文信息，**是节点间数据传递的主要媒介**
- `next`：调用下一个插件节点的函数
- 插件可以：
  - **修改 context（最常用）**：更新游戏状态、时间信息、用户数据等
  - 修改请求后传递给下一个节点

#### 2.1.4 整体架构与工作流程

```
┌─────────────────────┐     ┌─────────────────────┐     ┌─────────────────────┐
│                     │     │                     │     │                     │
│      前端应用        │────▶│    处理链管理器      │────▶│     LLM 服务        │
│    (React + Bun)    │◀────│  (Processing Chain) │◀────│    (OpenAI API)     │
│                     │     │                     │     │                     │
└─────────────────────┘     ├─────────────────────┤     └─────────────────────┘
                            │                     │     ┌─────────────────────┐
                            │  ┌─────────────────┐│     │                     │
                            │  │   预处理阶段    ││     │   MongoDB (持久化)   │
                            │  ├─────────────────┤│     │                     │
                            │  │ 输入处理节点   ││     ├─────────────────────┤
                            │  │ 时间管理节点   ││     │    Redis (缓存)      │
                            │  │ 状态管理节点   ││     │                     │
                            │  └─────────────────┘│     └─────────────────────┘
                            │  ┌─────────────────┐│
                            │  │   事件生成阶段  ││
                            │  ├─────────────────┤│
                            │  │  LLM核心节点   ││
                            │  │ （生成事件+绑定context）│
                            │  └─────────────────┘│
                            │                     │
                            └─────────────────────┘
```

**工作流程：**
用户输入 → 前端 → 处理链 → [预处理阶段节点] → [事件生成阶段节点] → 前端 → 用户界面

- **预处理阶段**：准备LLM所需的所有上下文信息，包括输入处理、时间管理、状态加载等
- **事件生成阶段**：以LLM核心节点为中心，生成游戏事件并将 context 快照与事件绑定
- 预处理阶段包含多个独立插件节点，事件生成阶段主要由单个LLM核心节点完成
- 请求按顺序通过各个节点处理，每个节点主要通过修改context传递信息
- 责任链单并发处理，保证 context 一致性
### 2.2 前端架构
- **核心框架**：React 18 + TypeScript
- **构建工具**：Bun
- **状态管理**：Redux/Vuex/Zustand 等
- **路由管理**：React Router/Vue Router 等
- **UI 组件库**：Ant Design/Material UI 等

### 2.3 后端架构
- **核心框架**：Node.js (Express)
- **构建工具**：Bun
- **API 设计**：RESTful API
- **数据库**：MongoDB（持久化存储） + Redis（缓存）
- **LLM 集成**：OpenAI API 服务

## 3. 责任链式插件节点模块

WordVoyage 的所有功能通过处理链上的插件节点实现，每个节点负责特定功能。

### 3.1 核心插件节点链

处理链上的核心节点按两个阶段处理请求：

```
前端请求 → [预处理阶段] → [事件生成阶段] → 前端响应

预处理阶段：
输入处理节点 → 时间管理节点 → 状态管理节点

事件生成阶段：
LLM核心节点（生成事件+绑定context快照）
```

### 3.2 核心节点功能

- **输入处理节点 (InputProcessingNode)**：处理用户输入的分类与解析，识别输入类型（行动/思考、机制质疑）
- **时间管理节点 (TimeManagementNode)**：管理游戏内时间，为LLM提供时间参数，根据事件持续时间计算结束时间
- **状态管理节点 (StateManagementNode)**：管理游戏状态，加载当前游戏状态到 context
- **LLM核心节点 (LLMCoreNode)**：与OpenAI API交互，生成事件响应，并将对应的 context 快照绑定到事件

## 4. 责任链交互流程

### 4.1 核心交互流程

所有用户输入（行动/思考、机制质疑）均通过两阶段责任链处理：

```
1. 用户输入文字指令
2. 前端发送请求到后端处理链
3. **预处理阶段**：准备上下文信息
   a. 输入处理节点：分类解析输入，识别类型并提取关键信息
   b. 时间管理节点：添加当前时间点到context
   c. 状态管理节点：加载当前游戏状态到context
4. **事件生成阶段**：生成响应
   a. LLM核心节点：调用OpenAI API生成事件
      - 传递context（输入、时间、状态、生命体征、库存等）
      - 根据输入类型生成对应结果（场景/事件、机制调整等）
      - 包含事件持续时间（秒，整数）
      - 将生成的事件与当前context快照绑定，保证原子性
5. 响应沿处理链返回前端
6. 前端展示结果，等待用户下一次输入
```

### 4.2 机制质疑变体

当用户质疑游戏机制时，处理流程的特殊之处在于：

- 输入处理节点识别为"机制质疑"类型，提取用户的关注变更（如移除饥饿/口渴追踪）
- LLM核心节点根据用户的机制调整要求，更新 context 中对应的追踪字段
- 生成的事件反映了对游戏焦点的重新定义，后续事件生成不再受旧的追踪限制

## 5. 背景故事与游戏流程

### 5.1 初始背景
- **角色**：星际探险者
- **触发事件**：飞船异常迫降未知生命星球
- **初始状态**：飞船损坏，资源有限，生存需求迫切
- **关键装备**（故事背景）：生命体征监测手表（标准探险装备）
  - 前端UI呈现：健康、饥饿、口渴、疲劳等状态指标
  - 数据来源：后端 context 中存储的游戏状态
  - 说明：手表仅是前端展示游戏状态的主题化方式，不影响后端架构设计

### 5.2 游戏流程

1. **生存阶段**：保障基本生存（食物、水、氧气），管理资源，制作工具
2. **探索阶段**：探索星球，了解生态系统，发现新区域和生物
3. **发展阶段**：建立基地，发展科技，研究新技术
4. **改造阶段**：改造星球环境，建设文明，维护生态平衡
5. **离开阶段**：修复飞船，准备资源，开启新旅程

### 5.3 寿命限制
- 角色有自然寿命限制
- 可通过科技延长寿命
- 寿命耗尽后可重新开始游戏

## 6. Context 一致性与事件溯源

### 6.1 核心设计原则

- **事件-Context 绑定**：每个生成的事件都与对应的 context 快照绑定存储
- **原子性保证**：事件生成和 context 变更作为一个原子操作，要么全部成功，要么全部失败
- **单并发处理**：责任链同一时刻只处理一个请求，避免并发修改 context
- **完整溯源**：可通过事件历史追溯任意时刻的 context 状态

### 6.2 Context 数据结构

Context 包含以下核心信息：

- **游戏状态**：用户关注的动态追踪字段（如生命体征、库存、环境状态等）
- **时间信息**：当前游戏时间点
- **输入信息**：用户当前输入的原始内容和分类
- **元数据**：事件ID、会话ID等辅助信息

**Context 限制：**
- 追踪字段数量有上限（初期设定为报错，后续通过UI引导用户管理）
- 不进行摘要压缩（保证事件生成质量）

### 6.3 事件存储结构

每个事件包含：

```
Event {
  id: string;                    // 事件唯一标识
  timestamp: number;             // 生成时间戳
  userInput: string;             // 用户输入
  generatedContent: string;      // LLM生成的事件内容
  duration: number;              // 事件持续时间（秒）
  contextSnapshot: Context;      // 绑定的context快照
}
```

### 6.4 失败恢复机制

- LLM API 调用失败时，不更新 context，向用户返回错误信息
- 保留上一个成功事件的 context 状态
- 用户可重试，责任链从预处理阶段重新开始

## 7. 技术选型建议

### 7.1 前端
- **框架**：React 18 + TypeScript
- **工具链**：Bun (构建/包管理)
- **状态管理**：Zustand
- **UI**：Tailwind CSS + 自定义组件
- **路由**：React Router v6
- **请求**：Axios

### 7.2 后端
- **框架**：Node.js + Express.js
- **工具链**：Bun (构建/包管理)
- **数据库**：MongoDB (持久化) + Redis (缓存)
- **LLM**：OpenAI API SDK
- **认证**：JWT
- **文档**：Swagger/OpenAPI

### 7.3 基础设施
- **部署**：Docker + Kubernetes
- **CI/CD**：GitHub Actions
- **监控**：Prometheus + Grafana
- **日志**：Winston + ELK Stack

## 8. 责任链架构扩展性说明

### 8.1 扩展兼容性

责任链架构为未来扩展提供了强大支持：

- **MOD 系统**：可通过处理链扩展新功能
- **多LLM协作**：可通过多个LLM节点分工完成复杂事件生成
- **跨平台支持**：可通过平台适配节点实现移动端、桌面端支持
- **VR/AR 体验**：可通过新增 VR/AR 节点实现沉浸式交互
- **多星球系统**：可通过新增星球管理节点实现星际旅行

## 9. 开发计划

### 9.1 第一阶段（核心框架）
- 前后端基础架构搭建（Bun + React + Node.js）
- 处理链核心引擎实现
- 基础节点接口定义
- 数据库集成（MongoDB + Redis）
- 事件溯源机制实现（Event-Context 绑定）
- LLM 核心节点实现

### 9.2 第二阶段（核心功能）
- 输入处理、时间管理、状态管理节点开发
- LLM核心节点功能完善（叙事生成、事件生成）
- Context 一致性保障机制

### 9.3 第三阶段（功能完善）
- 机制质疑功能实现（用户自定义关注点）
- Context 字段数量限制与UI引导
- 动态状态管理优化
- UI/UX 优化（手表主题展示）

### 9.4 第四阶段（扩展与优化）
- 高级系统实现（星球改造、飞船修复、寿命限制）
- 多LLM协作探索
- MOD系统探索
- 跨平台适配
