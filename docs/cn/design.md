# WordVoyage 设计文档

## 1. 项目概述

WordVoyage 是一个基于 AI 的文字沙盒冒险游戏，采用前后端分离的 Web 应用架构。游戏以星际探险为背景，用户通过文字描述行动与思考，AI 生成动态场景与事件，打造无边界的沙盒冒险体验。

### 1.1 核心特点
- **前后端分离架构**：前端负责用户交互与界面展示，后端处理业务逻辑与 LLM 集成，均使用 Bun 进行管理
- **沙盒冒险主题**：无固定目标，类似 Minecraft 的开放式玩法
- **AI 驱动叙事**：基于 OpenAI LLM 服务生成动态场景与事件
- **动态状态管理**：根据用户关注的事物动态记录游戏状态
- **双向交互机制**：支持用户行动描述与游戏机制质疑

## 2. 系统架构

WordVoyage 采用 **两阶段责任链架构**，以 LLM 对话为核心，所有功能通过处理链上的插件节点实现。

### 2.1 责任链核心设计

#### 2.1.1 核心设计理念
- **单一处理链**：所有请求（用户输入等）通过一条处理链传递
- **两阶段处理**：核心流程简化为预处理和事件生成两个主要阶段
- **上下文驱动**：通过修改 context 来处理数据和状态（如修改时间、背包物资、生命体征等）
- **事件溯源**：每个事件都绑定对应的 context 状态快照，保证事件生成和 context 变更的原子性

#### 2.1.2 核心组件
- **处理链 (Processing Chain)**：请求处理的核心通道，按顺序传递请求
- **插件节点 (Plugin Node)**：链上的处理单元，每个节点实现特定功能
- **LLM 核心 (LLM Core)**：链上的关键节点，负责与 OpenAI API 交互
- **Context (上下文)**：包含游戏状态的键值对字典，节点间通过修改 context 进行交互
- **Event (事件)**：一段文本描述，表示在这段时间内沙盒世界发生的事情
- **PreLogSummary (前文摘要)**：对历史事件的总结，用于为 LLM 生成下一个事件提供上下文
- **Step (步骤)**：完整的游戏步骤，包含 Context + Event + PreLogSummary 三部分

#### 2.1.3 节点接口

所有插件节点只需要实现以下极简接口：

```typescript
interface PluginNode {
  // 插件节点元信息
  metadata: {
    id: string;           // 唯一标识符
    name: string;         // 名称
    version: string;      // 版本
  };
  
  // 处理请求（核心方法）
  process(request: Request, context: Context, next: () => Promise<Response>): Promise<Response>;
}
```

**接口说明：**
- `request`：当前处理的请求对象
- `context`：包含全局状态和上下文信息，**是节点间数据传递的主要媒介**
- `next`：调用下一个插件节点的函数
- 插件可以：
  - **修改 context（最常用）**：更新游戏状态、时间信息、用户数据等
  - 修改请求后传递给下一个节点

#### 2.1.4 整体架构与工作流程

```
┌─────────────────────┐     ┌─────────────────────┐     ┌─────────────────────┐
│                     │     │                     │     │                     │
│      前端应用        │────▶│    处理链管理器      │────▶│     LLM 服务        │
│    (React + Bun)    │◀────│  (Processing Chain) │◀────│    (OpenAI API)     │
│                     │     │                     │     │                     │
└─────────────────────┘     ├─────────────────────┤     └─────────────────────┘
                            │                     │     ┌─────────────────────┐
                            │  ┌─────────────────┐│     │                     │
                            │  │   预处理阶段    ││     │   MongoDB (持久化)   │
                            │  ├─────────────────┤│     │                     │
                            │  │ 输入处理节点   ││     ├─────────────────────┤
                            │  │ 时间管理节点   ││     │    Redis (缓存)      │
                            │  │ 状态管理节点   ││     │                     │
                            │  └─────────────────┘│     └─────────────────────┘
                            │  ┌─────────────────┐│
                            │  │   事件生成阶段  ││
                            │  ├─────────────────┤│
                            │  │  LLM核心节点   ││
                            │  │ （生成事件+绑定context）│
                            │  └─────────────────┘│
                            │                     │
                            └─────────────────────┘
```

**工作流程：**
用户输入 → 前端 → 处理链 → [预处理阶段节点] → [事件生成阶段节点] → 前端 → 用户界面

- **预处理阶段**：准备LLM所需的所有上下文信息，包括输入处理、时间管理、状态加载、前文摘要生成等
- **事件生成阶段**：以LLM核心节点为中心，根据 context 和 preLogSummary 生成游戏事件，并收集 context 变更
- 预处理阶段包含多个独立插件节点，事件生成阶段主要由单个LLM核心节点完成
- 请求按顺序通过各个节点处理，每个节点主要通过修改context传递信息
- 每个用户会话单并发处理，保证 context 一致性（单机程序，不考虑多用户）
### 2.2 前端架构
- **核心框架**：React 18 + TypeScript
- **构建工具**：Bun
- **状态管理**：Redux/Vuex/Zustand 等
- **路由管理**：React Router/Vue Router 等
- **UI 组件库**：Ant Design/Material UI 等

### 2.3 后端架构
- **核心框架**：Node.js (Express)
- **构建工具**：Bun
- **API 设计**：RESTful API
- **数据库**：Redis（KV 存储，足以支撑所有存储需求）
- **认证方式**：JWT + Session 混合模式
- **LLM 集成**：OpenAI API 服务
- **部署模式**：单机程序，不考虑多用户并发

## 3. 责任链式插件节点模块

WordVoyage 的所有功能通过处理链上的插件节点实现，每个节点负责特定功能。

### 3.1 核心插件节点链

处理链上的核心节点按两个阶段处理请求：

```
前端请求 → [预处理阶段] → [事件生成阶段] → 前端响应

预处理阶段：
输入处理节点 → 时间管理节点 → 状态管理节点 → 前文摘要节点

事件生成阶段：
LLM核心节点（基于context+preLogSummary生成事件+context变更）
```

### 3.2 核心节点功能

**预处理阶段节点：**

- **输入处理节点 (InputProcessingNode)**：处理用户输入的分类与解析，识别输入类型（行动/思考、机制质疑）
- **时间管理节点 (TimeManagementNode)**：计算当前游戏时间点，将其添加到context
- **状态管理节点 (StateManagementNode)**：从Redis加载当前游戏状态到context
- **前文摘要节点 (PreLogSummaryNode)**：根据历史Step生成PreLogSummary（全量摘要 + 最近N个事件）

**事件生成阶段节点：**

- **LLM核心节点 (LLMCoreNode)**：
  - 基于 context + preLogSummary + 用户输入，调用OpenAI API
  - 生成事件描述文本
  - 生成context变更（仅包含变化的字段）
  - 应用context变更，将完整Step存储到Redis

## 4. 责任链交互流程

### 4.1 核心交互流程

所有用户输入（行动/思考、机制质疑）均通过两阶段责任链处理：

```
1. 用户输入文字指令
2. 前端发送请求到后端处理链
3. **预处理阶段**：准备LLM所需的信息
   a. 输入处理节点：分类解析输入，识别类型（行动/思考、机制质疑）
   b. 时间管理节点：计算当前游戏时间点
   c. 状态管理节点：从Redis加载当前游戏状态到context
   d. 前文摘要节点：根据历史事件生成PreLogSummary
4. **事件生成阶段**：生成响应
   a. LLM核心节点：
      - 基于 context + preLogSummary + 用户输入，调用OpenAI API
      - 生成事件描述文本（表示这段时间沙盒世界发生了什么）
      - 生成context变更（仅包含变化的key-value对）
      - 返回事件内容和context变更
   b. Context更新和持久化：
      - 应用context变更到当前context
      - 将完整Step（context + event + preLogSummary）保存到Redis
      - 事件流逝对应的游戏时间
5. 响应沿处理链返回前端
6. 前端展示事件内容和更新后的context，等待用户下一次输入
```

### 4.2 机制质疑变体

当用户质疑游戏机制时，处理流程的特殊之处在于：

- 输入处理节点识别为"机制质疑"类型，提取用户对context字段的调整需求
- LLM核心节点理解用户需求，生成对应的 context 变更指令（删除字段、添加字段等）
- 如用户认为饥饿不重要，直接从 context 移除 hunger 字段
- 生成的事件反映了对游戏焦点的重新定义，后续事件生成基于新的context结构

## 5. 背景故事与游戏流程

### 5.1 初始背景
- **角色**：星际探险者
- **触发事件**：飞船异常迫降未知生命星球
- **初始状态**：飞船损坏，资源有限，生存需求迫切
- **关键装备**（故事背景）：生命体征监测手表（标准探险装备）
  - 前端UI呈现：健康、饥饿、口渴、疲劳等状态指标
  - 数据来源：后端 context 中存储的游戏状态
  - 说明：手表仅是前端展示游戏状态的主题化方式，不影响后端架构设计

### 5.2 游戏流程

1. **生存阶段**：保障基本生存（食物、水、氧气），管理资源，制作工具
2. **探索阶段**：探索星球，了解生态系统，发现新区域和生物
3. **发展阶段**：建立基地，发展科技，研究新技术
4. **改造阶段**：改造星球环境，建设文明，维护生态平衡
5. **离开阶段**：修复飞船，准备资源，开启新旅程

### 5.3 寿命限制
- 角色有自然寿命限制
- 可通过科技延长寿命
- 寿命耗尽后可重新开始游戏

## 6. 数据模型与存储设计

### 6.1 核心设计原则

- **Step 原子性**：Context + Event + PreLogSummary 构成完整的游戏步骤，作为一个原子单元存储
- **事件串行**：所有事件串行生成，每个事件生成完毕后时间即流逝
- **会话单并发**：每个会话同一时刻只处理一个请求，避免并发修改 context
- **完整溯源**：可通过 Step 历史追溯任意时刻的游戏状态（后续可用于存档、回溯等功能）

### 6.2 Context 数据结构

Context 是一个键值对字典，存储游戏状态信息：

```typescript
Context {
  // 核心游戏状态字典
  state: {
    [key: string]: ContextField;
  };

  // 游戏时间
  gameTime: number;  // 游戏内时间戳（秒）
}

// Context 字段定义（精简结构）
ContextField {
  value: any;                    // 字段值（number, string, object 等）
  type: 'number' | 'string' | 'object' | 'array';  // 值类型
  description?: string;          // 字段语义描述（供 LLM 理解）
}
```

**Context 限制：**
- state 字典的 key 数量上限：可配置，默认 16
- 超过上限时报错，引导用户通过机制质疑移除不重要的字段
- 不对 context 进行摘要压缩（保证事件生成质量）

### 6.3 PreLogSummary 结构

PreLogSummary 是对历史事件的摘要，用于让 LLM 理解前文：

```typescript
PreLogSummary {
  summary: string;               // 历史事件摘要文本
  recentEvents: string[];        // 最近N个事件的完整文本（如最近3个）
  generatedAt: number;           // 摘要生成时间戳
}
```

### 6.4 Event 结构

Event 是 LLM 生成的结果，包含事件描述和 context 变更：

```typescript
Event {
  description: string;           // 事件描述文本（这段时间沙盒世界发生了什么）
  contextChanges: {              // context 变更（仅包含变化的字段）
    [key: string]: ContextField | null;  // null 表示删除该字段
  };
}
```

### 6.5 Step 存储结构

Step 是完整的游戏步骤，作为一个原子单元存储到 Redis：

```typescript
Step {
  id: string;                    // 步骤唯一标识
  timestamp: number;             // 生成时间戳（真实时间）
  userInput: string;             // 用户输入
  inputType: 'action' | 'question';  // 输入类型（行动/思考、机制质疑）

  // 完整的三元组
  context: Context;              // 应用变更后的完整 context 快照
  event: Event;                  // LLM 生成的事件
  preLogSummary: PreLogSummary;  // 前文摘要
}
```

### 6.6 错误处理机制

- **不可恢复错误**：责任链中任何节点失败，立即中断处理链，返回错误
  - LLM API 调用失败
  - Redis 存储失败
  - Context 字段数量超限
- **错误恢复**：失败后不更新 context，保留上一个成功 Step 的状态
- **重试机制**：用户可重试，责任链从预处理阶段重新开始

## 7. 技术选型建议

### 7.1 前端
- **框架**：React 18 + TypeScript
- **工具链**：Bun (构建/包管理)
- **状态管理**：Zustand
- **UI**：Tailwind CSS + 自定义组件
- **路由**：React Router v6
- **请求**：Axios

### 7.2 后端
- **框架**：Node.js + Express.js
- **工具链**：Bun (构建/包管理)
- **数据库**：Redis（KV 存储）
- **认证**：JWT + Session 混合模式
- **LLM**：OpenAI API SDK
- **文档**：Swagger/OpenAPI

### 7.3 基础设施
- **部署**：Docker + Kubernetes
- **CI/CD**：GitHub Actions
- **监控**：Prometheus + Grafana
- **日志**：Winston + ELK Stack

## 8. 责任链架构扩展性说明

### 8.1 扩展兼容性

责任链架构为未来扩展提供了强大支持：

- **MOD 系统**：可通过处理链扩展新功能
- **多LLM协作**：可通过多个LLM节点分工完成复杂事件生成
- **跨平台支持**：可通过平台适配节点实现移动端、桌面端支持
- **VR/AR 体验**：可通过新增 VR/AR 节点实现沉浸式交互
- **多星球系统**：可通过新增星球管理节点实现星际旅行

## 9. 开发计划

### MVP 阶段范围
MVP 包含第一阶段（工程框架）和第二阶段（业务逻辑），目标是完成一个最小化可玩版本：用户能通过文字指令驱动游戏进程，LLM 生成符合逻辑的事件，状态动态更新，支持完整的事件溯源。

### 9.1 第一阶段：工程框架（2-3 周）

**目标**：搭建完整的前后端基础架构，打通技术栈。

**关键功能：**
- 前后端基础项目搭建（Bun + React 18 + Node.js + Express）
- 处理链核心引擎：实现链式执行、节点接口、上下文传递、错误处理
- Redis 存储：Session 管理、Step 数据结构、认证框架
- 基础节点骨架：InputProcessingNode、TimeManagementNode、StateManagementNode、PreLogSummaryNode、LLMCoreNode（暂时 Mock）
- API 端点：游戏开始、处理用户步骤、查询 context、历史记录
- 前端极简 UI：输入框、事件显示、context 表格、加载状态

**验收标准：**
- 前后端能正常通信，处理链完整执行
- Step 能正确存储到 Redis 并读取
- 项目结构清晰规范

### 9.2 第二阶段：业务逻辑（3-4 周）

**目标**：实现完整的游戏逻辑，完成 MVP。

**关键功能：**
- LLM 集成：OpenAI API 调用、提示词工程、结构化输出解析（事件描述 + context 变更）
- 输入处理节点：分类用户输入（行动/思考 vs 机制质疑），基础验证
- 时间管理节点：游戏内时间计算
- 状态管理节点：加载/保存 context，字段数量校验（超过 16 报错）
- 前文摘要节点：从历史 Step 生成 PreLogSummary（摘要文本 + 最近 N 个完整事件）
- LLM 核心节点：组装完整的 LLM 调用参数、解析响应、应用 context 变更、存储 Step
- 初始化流程：新游戏时创建初始 context（5 个基础字段：health、hunger、thirst、energy、location）
- 机制质疑处理：用户通过机制质疑删除或修改 context 字段（如删除 hunger 字段表示已解决温饱）
- 基础测试：核心流程的单元测试和集成测试

**验收标准（MVP 完成）：**
- 用户能开始新游戏，看到初始剧情
- 用户输入行动后，LLM 生成符合逻辑的事件，context 正确更新
- PreLogSummary 正确生成，LLM 能理解历史上下文
- 用户能通过机制质疑移除或修改不需要的 context 字段
- Context 字段数量超过 16 时报错
- Step 完整存储，支持历史查询
- 前端能流畅展示整个游戏流程

### 9.3 第三阶段及以后

后续版本将实现以下增强：

**性能与成本优化：**
- 多 LLM 协作（使用便宜 LLM 处理简单任务，如摘要生成）
- 响应缓存策略
- 前文摘要的增量更新优化

**用户体验增强：**
- 流式响应（SSE）展示逐字生成的事件
- 历史回溯和分支探索（基于事件溯源）
- Context 字段管理 UI（提前引导避免超限）
- 手表主题 UI 展示

**功能完善：**
- 机制质疑 UI 优化
- 高级游戏系统（星球改造、飞船修复、寿命限制）
- MOD 系统探索
- 跨平台适配

## 10. 长期规划

### 10.1 安全性与合规
- 输入内容过滤和长度限制
- LLM 输出内容审核
- 速率限制和防滥用机制
- 数据隐私保护

### 10.2 多用户与协作支持
- 多用户会话管理
- 共享世界与多人协作探索
- 用户间交互和影响系统

### 10.3 平台扩展
- 移动端适配（iOS/Android）
- VR/AR 沉浸式体验
- 多星球系统和星际旅行
- MOD 生态和社区创意分享
